<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Class Details (Teacher View)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="top-buttons" style="display: flex; justify-content: space-between; align-items: center;">
        <a href="/teacher_dashboard" class="button">Dashboard</a>
        <form action="/delete_class" method="post" onsubmit="return confirm('Are you sure you want to delete this class? All associated data will be removed.')">
            <input type="hidden" name="class_id" value="{{ class_info['id'] }}">
            <input type="hidden" name="teacher_id" value="{{ teacher_id }}">
            <button type="submit" class="submit-button danger">Delete Class</button>
        </form>
    </div>

    <h1>{{ class_info['class_name'] }}</h1>
    <h2>Subject: {{ class_info['subject'] }}</h2>
    <h3>Teacher: {{ class_info['teacher_name'] }}</h3>

    <h3>Students in this Class:</h3>
    <ul class="student-list">
        {% for student in students %}
        <li style="display:flex;align-items:center;justify-content:space-between;">
            <span>
                <a href="/student_details/{{ student['id'] }}/{{ class_info['id'] }}/{{ teacher_id }}">
                    {{ student['name'] }} (Class Skill Level: {{ student['class_skill_level'] }})
                </a>
            </span>
            <span style="display:flex;align-items:center;gap:8px;">
                {# Warnsymbol, wenn Skill Level 1-3 und weniger als 25% erledigt #}
                {% set total_tasks = total_homework_per_student[student['id']] if total_homework_per_student and student['id'] in total_homework_per_student else 0 %}
                {% set completed_tasks = completed_homework_per_student[student['id']] if completed_homework_per_student and student['id'] in completed_homework_per_student else 0 %}
                {% set percent = (completed_tasks / total_tasks * 100) if total_tasks > 0 else 0 %}
                {% if student['class_skill_level'] <= 3 and percent < 50 %}
                    <span title="Student at risk: Low skill level and low participation" style="color:red;font-size:1.5em;margin-left:8px;">&#10071;</span>
                {% else %}
                <span title="Student is on track" style="color:green;font-size:1.5em;margin-left:8px;">&#10003;</span>
                {% endif %}
            </span>
        </li>
        {% endfor %}
    </ul>

    <div style="display: flex; gap: 32px; justify-content: center; margin-top: 32px;">
        <!-- Team Challenges -->
        <div style="flex:1; min-width:300px;">
            <h3>Team Challenges:</h3>
            <ul class="class-list">
                {% for tc in team_challenges %}
                    <li>
                        <a href="{{ url_for('view_homework_teacher', homework_id=tc.id, class_id=class_info['id'], teacher_id=teacher_id) }}">
                            {{ tc.title }} (Created on: {{ tc.date_created }})
                        </a>
                        - <strong>Status:</strong>
                        {% if tc.status == 'published' %}
                            <span style="color: green;">Published</span>
                        {% else %}
                            <span style="color: orange;">Draft</span>
                        {% endif %}
                        <br>
                        <b>Goal:</b> {{ tc.goal_score }} | <b>Current:</b> {{ tc.current_score }}
                    </li>
                {% else %}
                    <li style="color:#888;">No Teamchallanges Created so far.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Normale Hausaufgaben -->
        <div style="flex:1; min-width:300px;">
            <h3>Homework:</h3>
            <ul class="class-list">
                {% for homework in homework_list %}
                    <li>
                        <a href="{{ url_for('view_homework_teacher', homework_id=homework['id'], class_id=class_info['id'], teacher_id=teacher_id) }}">
                            {{ homework['title'] }} (Created on: {{ homework['date_created'] }})
                        </a>
                        - <strong>Status:</strong>
                        {% if homework['status'] == 'published' %}
                            <span style="color: green;">Published</span>
                        {% else %}
                            <span style="color: orange;">Draft</span>
                        {% endif %}
                    </li>
                {% else %}
                    <li style="color:#888;">Keine normalen Hausaufgaben f√ºr diese Klasse.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <h3>Class Progress</h3>
    <div class="chart-container" style="display: flex; gap: 20px; justify-content: center;">
        <div style="flex: 1; max-width: 50%; height: 300px;">
            <canvas id="classProgressChart"></canvas>
        </div>
        <div style="flex: 1; max-width: 50%; height: 300px;">
            <canvas id="classSkillChart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="create-content-fixed">
        <button class="button" onclick="openContentModal()">Create Learning Content</button>
    </div>

    <div id="content-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:4000;">
      <div style="background:#fff; padding:28px 28px 20px 28px; border-radius:14px; max-width:440px; margin:auto; box-shadow:0 8px 32px rgba(0,0,0,0.18); display:flex; flex-direction:column; align-items:center;">
        <h3 style="margin-top:0; margin-bottom:18px; text-align:center; font-size:1.5em;">Create Learning Content</h3>
        <label style="margin-bottom:6px; font-weight:500; text-align:center; width:100%;">Content Type:</label>
        <select id="content-type" onchange="toggleContentFields()" style="margin-bottom:18px; width:80%; padding:6px; border-radius:6px; text-align:center; font-size:1em;">
          <option value="mc">Multiple Choice</option>
          <option value="open">Open Question</option>
        </select>
        <div id="mc-fields" style="width:100%; display:flex; flex-direction:column; align-items:center;">
          <label style="margin-bottom:4px; font-weight:500; text-align:center; width:100%;">Title:</label>
          <input type="text" id="mc-title" style="margin-bottom:10px; width:90%; padding:6px; border-radius:6px; text-align:center;">
          <label style="margin-bottom:4px; font-weight:500; text-align:center; width:100%;">Description:</label>
          <textarea id="mc-desc" style="width:90%; min-height:60px; border-radius:6px; padding:6px; margin-bottom:10px; text-align:center;"></textarea>
        </div>
        <div id="open-fields" style="display:none; width:100%; flex-direction:column; align-items:center;">
          <label style="margin-bottom:4px; font-weight:500; text-align:center; width:100%;">Title:</label>
          <input type="text" id="open-title" style="margin-bottom:10px; width:90%; padding:6px; border-radius:6px; text-align:center;">
          <label style="margin-bottom:4px; font-weight:500; text-align:center; width:100%;">Description:</label>
          <textarea id="open-desc" style="width:90%; min-height:60px; border-radius:6px; padding:6px; margin-bottom:10px; text-align:center;"></textarea>
        </div>
        <div id="essay-fields" style="display:none; width:100%; flex-direction:column; align-items:center;">
          <label style="margin-bottom:4px; font-weight:500; text-align:center; width:100%;">Essay Prompt:</label>
          <textarea id="essay-prompt" style="width:90%; min-height:60px; border-radius:6px; padding:6px; margin-bottom:10px; text-align:center;"></textarea>
        </div>
        <!-- Team Challenge Auswahl -->
        <label style="margin-bottom:6px; font-weight:500; text-align:center; width:100%;">
            <input type="checkbox" id="is-team-challenge" onchange="toggleTeamChallengeFields(this.checked)">
            Team Challenge
        </label>
        <div id="team-challenge-fields" style="display:none; width:100%; flex-direction:column; align-items:center; margin-bottom:10px;">
            <label style="margin-bottom:4px; font-weight:500; text-align:center; width:100%;">Start Time:
                <input type="datetime-local" id="team-start-time" style="margin-bottom:6px; width:90%; padding:6px; border-radius:6px;">
            </label>
            <label style="margin-bottom:4px; font-weight:500; text-align:center; width:100%;">End Time:
                <input type="datetime-local" id="team-end-time" style="margin-bottom:6px; width:90%; padding:6px; border-radius:6px;">
            </label>
            <label style="margin-bottom:4px; font-weight:500; text-align:center; width:100%;">Goal Score:
                <input type="number" id="team-goal-score" min="1" style="margin-bottom:6px; width:90%; padding:6px; border-radius:6px;">
            </label>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px; width:100%; justify-content:center;">
          <button onclick="submitContent()" class="button" style="min-width:100px;">Create</button>
          <button onclick="closeContentModal()" class="button" style="min-width:100px;">Cancel</button>
          <button type="button" onclick="showContentPrompt()" class="button" style="min-width:120px;">Show Full Prompt</button>
        </div>
        <pre id="content-full-prompt" style="display:none; background:#f6f6f6; padding:12px; margin-top:14px; max-width:100%; max-height:300px; overflow-x:auto; overflow-y:auto; border-radius:8px; font-size:0.97em;"></pre>
      </div>
    </div>

    <script>
        // Average Correct Answers in %
        const correctCtx = document.getElementById('classProgressChart').getContext('2d');
        const correctData = {
            labels: {{ dates | tojson }},
            datasets: [{
                label: 'Avg Correct Answers (%)',
                data: {{ avg_percent_corrects | tojson }},
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        };
        const correctConfig = {
            type: 'line',
            data: correctData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'Avg Correct Answers per Homework (%)',
                        font: { size: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return {{ titles | tojson }}[index];
                            },
                            label: function(tooltipItem) {
                                return `Avg Correct Answers: ${tooltipItem.raw}%`;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'Date' }
                    },
                    y: { 
                        min: 0, 
                        max: 100, 
                        stepSize: 10, 
                        title: { display: true, text: 'Avg Correct Answers (%)' } 
                    }
                }
            }
        };
        new Chart(correctCtx, correctConfig);

        // Average Skill Level
        const skillCtx = document.getElementById('classSkillChart').getContext('2d');
        const skillData = {
            labels: {{ dates | tojson }},
            datasets: [{
                label: 'Avg Skill Level',
                data: {{ avg_skill_levels | tojson }},
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        };
        const skillConfig = {
            type: 'line',
            data: skillData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'Avg Skill Level per Homework',
                        font: { size: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return {{ titles | tojson }}[index];
                            },
                            label: function(tooltipItem) {
                                return `Avg Skill Level: ${tooltipItem.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        title: { display: true, text: 'Date' }
                    },
                    y: { 
                        min: 1, 
                        max: 10, 
                        stepSize: 1, 
                        title: { display: true, text: 'Avg Skill Level' } 
                    }
                }
            }
        };
        new Chart(skillCtx, skillConfig);

        function pad(n) { return n < 10 ? '0' + n : n; }
        function getLocalDateTimeString(date) {
            return date.getFullYear() + '-' +
                pad(date.getMonth() + 1) + '-' +
                pad(date.getDate()) + 'T' +
                pad(date.getHours()) + ':' +
                pad(date.getMinutes());
        }

        function openContentModal() {
            document.getElementById('content-modal').style.display = 'flex';

            // Team Challenge Default-Werte setzen
            const now = new Date();
            const in7days = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            document.getElementById('team-start-time').value = getLocalDateTimeString(now);
            document.getElementById('team-end-time').value = getLocalDateTimeString(in7days);
            document.getElementById('team-goal-score').value = 100;
        }
        function closeContentModal() {
            document.getElementById('content-modal').style.display = 'none';
        }
        function toggleContentFields() {
            const type = document.getElementById('content-type').value;
            document.getElementById('mc-fields').style.display = (type === 'mc') ? 'block' : 'none';
            document.getElementById('open-fields').style.display = (type === 'open') ? 'block' : 'none';
            document.getElementById('essay-fields').style.display = (type === 'essay') ? 'block' : 'none';
        }

        function submitContent() {
            const type = document.getElementById('content-type').value;
            let payload = { type };
            if (type === 'mc') {
                payload.title = document.getElementById('mc-title').value;
                payload.desc = document.getElementById('mc-desc').value;
                payload.class_id = {{ class_info['id'] }};
                payload.teacher_id = {{ teacher_id }};
            }
            if (type === 'open') {
                payload.title = document.getElementById('open-title').value;
                payload.desc = document.getElementById('open-desc').value;
                payload.class_id = {{ class_info['id'] }};
                payload.teacher_id = {{ teacher_id }};
            }
            if (type === 'essay') {
                payload.essay_prompt = document.getElementById('essay-prompt').value;
            }

            // Team Challenge Felder
            const isTeam = document.getElementById('is-team-challenge').checked;
            payload.is_team_challenge = isTeam ? 1 : 0;
            if (isTeam) {
                payload.start_time = document.getElementById('team-start-time').value;
                payload.end_time = document.getElementById('team-end-time').value;
                payload.goal_score = document.getElementById('team-goal-score').value;
            }

            // Debug-Ausgabe
            console.log("Payload an Backend:", payload);

            fetch('/create_learning_content', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(resp => resp.json()).then(data => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
            });
        }
        function showContentPrompt() {
            const type = document.getElementById('content-type').value;
            let prompt = '';
            if (type === 'mc') {
                const title = document.getElementById('mc-title').value;
                const desc = document.getElementById('mc-desc').value;
                prompt = `
Create homework for the subject {{ class_info['subject'] }} in the grade {{ class_info['grade_level'] }}:
For reference, students have a skill_level between 1 and 10, with 10 being the best/most difficult.

Homework title: ${title}
Homework description: ${desc}

Based on Bloom's Taxonomy, the questions should be divided into the task types Remembering Understanding Applying Analysing Evaluating Creating.
1st level of difficulty (skill_level 1) 3 * Remembering, 3 * Understanding, 3 * Applying, 1 * Analysing
2nd level of difficulty (skill_level 4) 2 * Remembering, 3 * Understanding, 3 * Applying, 2 * Analysing
3rd level of difficulty (skill_level 8) 2 * Remembering, 2 * Understanding, 3 * Applying, 3 * Analysing
The homework should only contain multiple-choice questions. 
Each question should have four possible answers and the correct answer should be returned as an index (0-based).

Create a total of 30 questions: 10 questions per difficulty level.
Please answer only with JSON content in the following format:
[
    {"skill_level": 1, "questions": [
        {"question": "...", "options": ["...", "...", "...", "..."], "answer": 0, "explanation": "...", "taxonomy": "..."}
    ]},
    {"skill_level": 4, "questions": [
        {"question": "...", "options": ["...", "...", "...", "..."], "answer": 2, "explanation": "...", "taxonomy": "..."}
    ]},
    {"skill_level": 8, "questions": [
        {"question": "...", "options": ["...", "...", "...", "..."], "answer": 3, "explanation": "...", "taxonomy": "..."}
    ]}
]
                `;
            } else if (type === 'open') {
                const title = document.getElementById('open-title').value;
                const desc = document.getElementById('open-desc').value;
                prompt = `
Create open-ended homework for the subject {{ class_info['subject'] }} in the grade {{ class_info['grade_level'] }}:
For reference, students have a skill_level between 1 and 10, with 10 being the best/most difficult.

Homework title: ${title}
Homework description: ${desc}

Based on Bloom's Taxonomy, the questions should be divided into the task types Remembering, Understanding, Applying, Analysing, Evaluating, Creating.
For each of the following skill levels, generate 6 open-ended questions (one for each taxonomy type):
- skill_level 1 (easy): Remembering, Understanding, Applying, Analysing, Evaluating, Creating
- skill_level 4 (medium): Remembering, Understanding, Applying, Analysing, Evaluating, Creating
- skill_level 8 (hard): Remembering, Understanding, Applying, Analysing, Evaluating, Creating

For each question, also generate a sample solution (model answer) that would be considered a very good answer for a student.
Please answer only with JSON content in the following format:
[
    {"skill_level": 1, "questions": [
        {"question": "...", "sample_solution": "...", "taxonomy": "Remembering"},
        ... (total 6 questions, one per taxonomy)
    ]},
    {"skill_level": 4, "questions": [
        ... (6 questions)
    ]},
    {"skill_level": 8, "questions": [
        ... (6 questions)
    ]}
]
                `;
            } else if (type === 'essay') {
                const essay = document.getElementById('essay-prompt').value;
                prompt = `Create an essay task for the following prompt: ${essay}`;
            }
            const pre = document.getElementById('content-full-prompt');
            pre.innerText = prompt.trim();
            pre.style.display = 'block';
        }

        // Modal schlie√üen beim Klick au√üerhalb
        document.addEventListener('mousedown', function(event) {
            const modal = document.getElementById('content-modal');
            if (modal && modal.style.display === 'flex' && event.target === modal) {
                closeContentModal();
            }
        });

        function toggleTeamChallengeFields(show) {
            document.getElementById('team-challenge-fields').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>